version: '3.3'

networks:
  inventare:
    driver: bridge

services:
  database:
    image: mariadb
    volumes:
      - ./database/:/var/lib/mysql
    networks:
      - inventare
    environment:
      MYSQL_DATABASE: inventare
      MYSQL_ROOT_PASSWORD: root

  admin_migration_prod:
    build:
      context: ./packages/core/admin/
      dockerfile: Dockerfile.prod
    command: python manage.py migrate --noinput
    networks:
      - inventare
    environment:
      - SQL_ENGINE=django.db.backends.mysql
      - SQL_DATABASE=inventare
      - SQL_USER=root
      - SQL_PASSWORD=root
      - SQL_HOST=database
      - SQL_PORT=3306
    depends_on:
      - database

  admin_prod:
    build:
      context: ./packages/core/admin/
      dockerfile: Dockerfile.prod
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - ./packages/core/admin/media:/app/media
    networks:
      - inventare
    ports:
      - 8000:8000
    environment:
      - SQL_ENGINE=django.db.backends.mysql
      - SQL_DATABASE=inventare
      - SQL_USER=root
      - SQL_PASSWORD=root
      - SQL_HOST=database
      - SQL_PORT=3306
      - DEBUG=true
    depends_on: 
      - database
      - admin_migration_prod

  client_prod:
    build: ./packages/core/client/
    networks:
      - inventare
    ports:
      - 3000:3000
    depends_on:
      - admin_prod
